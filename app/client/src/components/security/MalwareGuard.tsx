import React, { useState, useEffect, useRef } from 'react';
import axios from 'axios';
import { ShieldCheck, FileScan, AlertTriangle, Activity, Database, Lock, Search, Play, Loader2, CheckCircle, Folder, CheckSquare, Plus, ChevronDown, ChevronUp, ChevronRight, MinusSquare, FileText } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

// --- TREE NODE COMPONENT FOR SELECTION ---
const TreeNode = ({ path, name, level, selectedPaths, onTogglePath }: any) => {
    const [expanded, setExpanded] = useState(false);
    const [children, setChildren] = useState<any[]>([]);
    const [loading, setLoading] = useState(false);
    const hasLoaded = useRef(false);

    const isSelected = selectedPaths.includes(path);

    const handleExpand = async (e: React.MouseEvent) => {
        e.stopPropagation(); // Don't toggle selection
        setExpanded(!expanded);

        if (!expanded && !hasLoaded.current) {
            setLoading(true);
            try {
                const res = await axios.get('/api/ls', { params: { path } });
                // Filter only directories
                const dirs = res.data.filter((item: any) => item.type === 'd' || item.type === 'directory');
                setChildren(dirs);
                hasLoaded.current = true;
            } catch (e) {
                console.error("Failed to load subs", e);
            }
            setLoading(false);
        }
    };

    return (
        <div className="select-none">
            <div
                className={`flex items-center gap-2 py-1 px-2 rounded hover:bg-[var(--nav-hover)] transition-colors text-sm font-mono cursor-pointer ${isSelected ? 'bg-blue-500/10 text-blue-400' : 'text-[var(--text-main)]'}`}
                style={{ paddingLeft: `${level * 16 + 8}px` }}
            >
                {/* Expand Button */}
                <div onClick={handleExpand} className="p-0.5 hover:bg-white/10 rounded cursor-pointer text-[var(--text-muted)]">
                    {loading ? <Loader2 size={12} className="animate-spin" /> :
                        expanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />
                    }
                </div>

                {/* Checkbox (Clicking row toggles selection) */}
                <div className="flex-1 flex items-center gap-2" onClick={() => onTogglePath(path)}>
                    {isSelected ? <CheckSquare size={14} className="text-blue-500" /> : <div className="w-[14px] h-[14px] border border-[var(--border)] rounded bg-[var(--bg-secondary)]" />}
                    <Folder size={14} className={isSelected ? "text-blue-500" : "text-[var(--text-muted)]"} />
                    <span>{name}</span>
                </div>
            </div>

            {/* Render Children */}
            {expanded && (
                <div>
                    {children.length === 0 && !loading && hasLoaded.current && (
                        <div style={{ paddingLeft: `${(level + 1) * 16 + 28}px` }} className="text-[10px] text-[var(--text-muted)] italic py-1">Empty or Access Denied</div>
                    )}
                    {children.map(child => (
                        <TreeNode
                            key={child.name}
                            path={path === '/' ? `/${child.name}` : `${path}/${child.name}`}
                            name={child.name}
                            level={level + 1}
                            selectedPaths={selectedPaths}
                            onTogglePath={onTogglePath}
                        />
                    ))}
                </div>
            )}
        </div>
    );
};
// -----------------------------------------

const MalwareGuard = () => {
    const [stats, setStats] = useState<any>(null);
    const [logs, setLogs] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    // Manual Scan State
    const [scanStatus, setScanStatus] = useState<'idle' | 'scanning' | 'complete' | 'error'>('idle');
    const [scanResult, setScanResult] = useState<any>(null);
    const [showDetails, setShowDetails] = useState(false);

    // Multi-Path Selection
    const [scanPaths, setScanPaths] = useState<string[]>(['/']);
    const [customPath, setCustomPath] = useState('');

    // Initial Root Dirs for Tree
    const [rootDirs, setRootDirs] = useState<any[]>([]);

    useEffect(() => {
        const fetchData = async () => {
            try {
                // Fetch stats & logs...
                const statsRes = await axios.get('/api/security/stats');
                setStats(statsRes.data);
                const threatsRes = await axios.get('/api/security/threats');
                const allThreats = threatsRes.data.recentThreats || [];
                const mwLogs = allThreats.filter((t: any) =>
                    t.threat_type === 'MALWARE BLOCKED' ||
                    t.threat_type === 'RANSOMWARE BLOCKED' ||
                    t.threat_type === 'RANSOMWARE ALERT'
                );
                setLogs(mwLogs);

                // Fetch Root for Tree
                try {
                    const listRes = await axios.get('/api/ls', { params: { path: '/' } });
                    const dirs = listRes.data.filter((item: any) => item.type === 'd' || item.type === 'directory');
                    setRootDirs(dirs);
                } catch (e) { }

            } catch (e) { console.error(e); }
            setLoading(false);
        };
        fetchData();
    }, []);

    const handleScan = async () => {
        if (scanPaths.length === 0) return;
        setScanStatus('scanning');
        setScanResult(null);
        setShowDetails(false);
        try {
            const res = await axios.post('/api/scan-files', { paths: scanPaths });
            setScanResult(res.data);
            setScanStatus('complete');
        } catch (e) {
            console.error(e);
            setScanStatus('error');
        }
    };

    const togglePath = (path: string) => {
        if (scanPaths.includes(path)) {
            setScanPaths(scanPaths.filter(p => p !== path));
        } else {
            setScanPaths([...scanPaths, path]);
        }
    };

    const addCustomPath = () => {
        if (!customPath) return;
        const normalized = customPath.startsWith('/') ? customPath : `/${customPath}`;
        if (!scanPaths.includes(normalized)) {
            setScanPaths([...scanPaths, normalized]);
        }
        setCustomPath('');
    };

    const downloadReport = async () => {
        if (!scanResult?.logId) return;
        try {
            const res = await axios.get(`/api/download-report/${scanResult.logId}`, { responseType: 'blob' });
            const url = window.URL.createObjectURL(new Blob([res.data]));
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', scanResult.logId);
            document.body.appendChild(link);
            link.click();
            link.remove();
        } catch (e) {
            console.error("Download failed", e);
            alert("Failed to download report. Session might differ.");
        }
    };

    return (
        <div className="space-y-6 animate-fade-in pb-10">
            {/* Header Stats */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">

                <div className="p-6 bg-gradient-to-br from-purple-500/10 to-transparent border border-purple-500/20 rounded-2xl relative overflow-hidden group">
                    <div className="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <Database size={100} />
                    </div>
                    <h3 className="text-purple-400 font-bold flex items-center gap-2 mb-4"><Lock className="animate-pulse" size={20} /> Ransomware Shield</h3>
                    <div className="flex items-end gap-4">
                        <div>
                            <p className="text-3xl font-black text-white">ACTIVE</p>
                            <p className="text-xs text-purple-500/60 font-bold uppercase tracking-widest mt-1">Protection Status</p>
                        </div>
                        <div className="text-right flex-1">
                            <p className="text-3xl font-black text-purple-500">{stats?.ransomwareBlocked || 0}</p>
                            <p className="text-xs text-[var(--text-muted)] font-bold uppercase tracking-widest mt-1">Attacks Blocked</p>
                        </div>
                    </div>
                </div>

                <div className="p-6 bg-gradient-to-br from-pink-500/10 to-transparent border border-pink-500/20 rounded-2xl relative overflow-hidden group">
                    <div className="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <FileScan size={100} />
                    </div>
                    <h3 className="text-pink-400 font-bold flex items-center gap-2 mb-4"><FileScan className="animate-pulse" size={20} /> Malware Scanner</h3>
                    <div className="flex items-end gap-4">
                        <div>
                            <p className="text-3xl font-black text-white">ACTIVE</p>
                            <p className="text-xs text-pink-500/60 font-bold uppercase tracking-widest mt-1">Real-time Engine</p>
                        </div>
                        <div className="text-right flex-1">
                            <p className="text-3xl font-black text-pink-500">{stats?.malwareBlocked || 0}</p>
                            <p className="text-xs text-[var(--text-muted)] font-bold uppercase tracking-widest mt-1">Files Rejected</p>
                        </div>
                    </div>
                </div>
            </div>

            {/* MAIN INTERFACE */}
            <div className="p-6 bg-[var(--bg-secondary)] border border-[var(--border)] rounded-2xl flex flex-col items-start gap-4">
                <div className="flex items-center gap-4 w-full">
                    <div className="p-3 bg-blue-500/10 text-blue-400 rounded-xl">
                        <Search size={32} />
                    </div>
                    <div>
                        <h3 className="font-bold text-lg text-[var(--text-main)]">System Integrity Scan</h3>
                        <p className="text-sm text-[var(--text-muted)]">Select directories to scan. Deep recursion (Unlimited Mode).</p>
                    </div>
                </div>

                <div className="w-full flex flex-col md:flex-row items-start gap-6 mt-2">
                    {/* LEFT: TARGET SELECTION */}
                    <div className="w-full md:flex-1 space-y-3">
                        <label className="text-xs font-bold text-[var(--text-muted)] uppercase flex justify-between">
                            <span>Target Directories</span>
                            <span className="text-[var(--primary)] cursor-pointer hover:underline" onClick={() => setScanPaths(['/'])}>Reset Root</span>
                        </label>

                        <div className="bg-[var(--bg-main)] border border-[var(--border)] rounded-xl overflow-hidden min-h-[160px] max-h-[300px] overflow-y-auto p-2 scrollbar-thin">
                            {/* Special Root Node */}
                            <div className={`flex items-center gap-2 py-1 px-2 rounded hover:bg-[var(--nav-hover)] transition-colors text-sm font-mono cursor-pointer mb-1 ${scanPaths.includes('/') ? 'bg-purple-500/10 text-purple-400' : 'text-[var(--text-main)]'}`} onClick={() => togglePath('/')}>
                                {scanPaths.includes('/') ? <CheckSquare size={14} className="text-purple-500" /> : <div className="w-[14px] h-[14px] border border-[var(--border)] rounded bg-[var(--bg-secondary)]" />}
                                <Database size={14} />
                                <span>/ (Scan Entire Root)</span>
                            </div>

                            {/* Dynamic Tree */}
                            {rootDirs.map(dir => (
                                <TreeNode
                                    key={dir.name}
                                    path={`/${dir.name}`}
                                    name={dir.name}
                                    level={0}
                                    selectedPaths={scanPaths}
                                    onTogglePath={togglePath}
                                />
                            ))}
                        </div>

                        {/* Custom Path Input */}
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={customPath}
                                onChange={(e) => setCustomPath(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && addCustomPath()}
                                placeholder="Manually add path..."
                                className="flex-1 bg-[var(--bg-main)] border border-[var(--border)] rounded-xl px-4 py-2 text-sm font-mono outline-none focus:border-blue-500/50"
                            />
                            <button
                                onClick={addCustomPath}
                                disabled={!customPath}
                                className="px-3 bg-[var(--bg-main)] hover:bg-[var(--nav-hover)] border border-[var(--border)] rounded-xl text-[var(--text-muted)] hover:text-blue-400 transition-colors"
                            >
                                <Plus size={18} />
                            </button>
                        </div>
                    </div>

                    {/* RIGHT: ACTIONS & STATUS */}
                    <div className="w-full md:w-auto flex flex-col gap-3 min-w-[240px]">
                        <div className="p-4 bg-[var(--bg-main)] rounded-xl border border-[var(--border)]">
                            <div className="text-xs font-bold text-[var(--text-muted)] uppercase mb-2">Selected Targets</div>
                            <div className="max-h-[100px] overflow-y-auto space-y-1 mb-3">
                                {scanPaths.map(p => (
                                    <div key={p} className="flex justify-between items-center text-xs font-mono text-blue-400 bg-blue-500/5 px-2 py-1 rounded">
                                        <span className="truncate max-w-[180px]">{p}</span>
                                        <button onClick={() => togglePath(p)} className="hover:text-red-500"><MinusSquare size={12} /></button>
                                    </div>
                                ))}
                                {scanPaths.length === 0 && <span className="text-xs text-[var(--text-muted)] italic">No paths selected</span>}
                            </div>

                            {scanStatus === 'idle' && (
                                <button
                                    onClick={handleScan}
                                    disabled={scanPaths.length === 0}
                                    className={`w-full py-3 font-bold rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all text-sm ${scanPaths.length === 0 ? 'bg-gray-500/20 cursor-not-allowed text-gray-400' : 'bg-blue-600 hover:bg-blue-700 text-white shadow-blue-600/20'}`}
                                >
                                    <Play size={16} fill="currentColor" /> START SCAN
                                </button>
                            )}

                            {scanStatus === 'scanning' && (
                                <div className="w-full py-3 flex items-center justify-center gap-3 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                                    <Loader2 size={16} className="animate-spin text-blue-500" />
                                    <span className="font-bold text-sm text-[var(--text-muted)]">Scanning...</span>
                                </div>
                            )}

                            {/* COMPLETE STATUS */}
                            {scanStatus === 'complete' && (
                                <div className="space-y-2">
                                    <div className="w-full py-3 flex flex-col items-center justify-center bg-green-500/10 border border-green-500/20 rounded-lg">
                                        <div className="flex items-center gap-2 text-green-500 font-bold mb-1">
                                            <CheckCircle size={16} /> Scan Completed
                                        </div>
                                        <div className="text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-wider">
                                            {scanResult?.scanned} Files Analyzed
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button
                                            onClick={() => setShowDetails(!showDetails)}
                                            className="w-full py-2 text-xs border border-[var(--border)] rounded hover:bg-[var(--nav-hover)] transition-colors flex items-center justify-center gap-2 font-bold text-blue-400"
                                        >
                                            {showDetails ? 'Hide' : 'View'} Log
                                        </button>
                                        {scanResult?.logId && (
                                            <button
                                                onClick={downloadReport}
                                                className="w-full py-2 text-xs border border-[var(--border)] rounded hover:bg-[var(--nav-hover)] transition-colors flex items-center justify-center gap-2 font-bold text-[var(--text-main)]"
                                            >
                                                <FileText size={12} /> Download
                                            </button>
                                        )}
                                    </div>
                                    <button
                                        onClick={() => { setScanStatus('idle'); setScanResult(null); setShowDetails(false); }}
                                        className="w-full py-2 mt-2 text-xs bg-blue-600 hover:bg-blue-700 text-white font-bold rounded shadow-lg transition-all flex items-center justify-center gap-2"
                                    >
                                        <Play size={12} fill="currentColor" /> Start New Scan
                                    </button>
                                </div>
                            )}

                            {scanStatus === 'error' && (
                                <div className="w-full py-3 flex items-center justify-center text-red-500 text-sm font-bold bg-red-500/10 border border-red-500/20 rounded-lg">
                                    Error Occurred
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                {/* LOG VIEWER */}
                {showDetails && scanResult?.scannedList && (
                    <div className="mt-4 animate-fade-in w-full">
                        <div className="bg-black/40 border border-[var(--border)] rounded-xl overflow-hidden font-mono text-[10px]">
                            <div className="bg-white/5 px-4 py-2 border-b border-white/5 font-bold text-[var(--text-muted)] flex justify-between items-center">
                                <span>SCAN TRANSCRIPT (Showing last 100)</span>
                                <span className={scanResult.scanned >= 1000000 ? "text-yellow-500" : "text-green-500"}>
                                    {scanResult.scanned} FILES
                                </span>
                            </div>
                            <div className="h-[200px] overflow-y-auto p-4 space-y-1">
                                {scanResult.scannedList.map((f: string, i: number) => (
                                    <div key={i} className="text-[var(--text-muted)] flex gap-2 hover:bg-white/5 px-1 rounded">
                                        <span className="text-blue-500/50 w-8 text-right select-none">{i + 1}.</span>
                                        <span className="truncate select-text">{f}</span>
                                        <span className="text-green-500 ml-auto select-none">[OK]</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
            </div>

            {/* INFECTION WARNING */}
            {scanStatus === 'complete' && scanResult?.infected.length > 0 && (
                <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-xl animate-fade-in">
                    <h4 className="flex items-center gap-2 text-red-500 font-bold mb-3"><AlertTriangle size={18} /> Threats Detected</h4>
                    <ul className="space-y-2">
                        {scanResult.infected.map((inf: any, idx: number) => (
                            <li key={idx} className="flex justify-between items-center text-sm p-2 bg-red-500/5 rounded">
                                <span className="font-mono text-red-400">{inf.path}</span>
                                <span className="font-bold text-red-500 uppercase text-xs">{inf.threat}</span>
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            {/* Logs Table */}
            <div className="bg-[var(--bg-secondary)] rounded-2xl border border-[var(--border)] overflow-hidden">
                <div className="p-4 border-b border-[var(--border)] flex justify-between items-center">
                    <h3 className="font-bold flex items-center gap-2 text-[var(--text-main)]">
                        <Activity size={18} className="text-red-500" /> Incident Logs
                    </h3>
                    <span className="text-xs font-bold px-2 py-1 rounded bg-[var(--bg-main)] text-[var(--text-muted)]">
                        {logs.length} EVENTS
                    </span>
                </div>

                <div className="max-h-[300px] overflow-y-auto">
                    {loading ? (
                        <div className="p-8 text-center text-[var(--text-muted)]">Loading security events...</div>
                    ) : logs.length === 0 ? (
                        <div className="p-12 flex flex-col items-center justify-center text-[var(--text-muted)] opacity-50">
                            <ShieldCheck size={48} className="mb-4" />
                            <p>No malware or ransomware incidents detected in the last 24h.</p>
                        </div>
                    ) : (
                        <table className="w-full text-left border-collapse text-sm">
                            <thead className="bg-black/20 text-[10px] uppercase font-bold text-[var(--text-muted)] sticky top-0 backdrop-blur-md">
                                <tr>
                                    <th className="p-4">Time</th>
                                    <th className="p-4">Threat Type</th>
                                    <th className="p-4">Source IP</th>
                                    <th className="p-4">Details</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-[var(--border)]">
                                {logs.map((log: any) => (
                                    <tr key={log.id} className="hover:bg-[var(--nav-hover)] transition-colors font-mono text-xs">
                                        <td className="p-4 text-[var(--text-muted)] whitespace-nowrap">
                                            {formatDistanceToNow(new Date(log.created_at), { addSuffix: true })}
                                        </td>
                                        <td className="p-4">
                                            <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${log.threat_type.includes('RANSOMWARE') ? 'bg-purple-500/20 text-purple-400' : 'bg-pink-500/20 text-pink-400'
                                                }`}>
                                                {log.threat_type}
                                            </span>
                                        </td>
                                        <td className="p-4 text-[var(--text-main)]">{log.ip}</td>
                                        <td className="p-4 text-[var(--text-muted)] truncate max-w-[300px]" title={log.details}>
                                            {JSON.parse(log.details)[0]?.detail || 'BLOCKED'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
        </div>
    );
};

export default MalwareGuard;
