const { logActivity } = require('../utils/logger');

// Signatures for common Web Shells and Malware in PHP/JS/Shell
const MALWARE_SIGNATURES = [
    { name: 'Generic PHP/JS Obfuscation (eval+base64)', pattern: /eval\s*\(\s*base64_decode/i },
    { name: 'Generic PHP Obfuscation (gzinflate)', pattern: /eval\s*\(\s*gzinflate/i },
    { name: 'Generic PHP Obfuscation (str_rot13)', pattern: /eval\s*\(\s*str_rot13/i },
    { name: 'C99 Web Shell', pattern: /c999\.main/i },
    { name: 'R57 Web Shell', pattern: /r57shell/i },
    { name: 'WSO Web Shell', pattern: /wso_login|wso_ver/i },
    { name: 'B374K Web Shell', pattern: /b374k/i },
    { name: 'IndoXploit Shell', pattern: /indoxploit/i },
    { name: 'Symlink Bypass', pattern: /symlink\s*\(/i },
    { name: 'Suspicious Shell Execution (system)', pattern: /system\s*\(\s*['"](wget|curl|chmod|rm|cat)/i },
    { name: 'Suspicious Shell Execution (shell_exec)', pattern: /shell_exec\s*\(/i },
    { name: 'Reverse Shell Attempt', pattern: /fsockopen\s*\(.*\/bin\/sh/i },
    { name: 'Crypto Miner (Coinhive/Monero)', pattern: /CoinHive\.Anonymous|miner\.start/i },
    { name: 'Powershell Execution', pattern: /powershell\.exe/i },
    // Virus / Windows Malware Extensions
    { name: 'OS Command Injection', pattern: /cmd\.exe\s*\/c|powershell\s+-enc/i },
    { name: 'VBScript Malware', pattern: /WScript\.Shell|FileSystemObject/i },
    { name: 'Suspicious Downloader', pattern: /URLDownloadToFile|WScript\.Network|Bitsadmin/i },
    { name: 'EICAR Test File (Virus Benchmark)', pattern: /X5O!P%@AP\[4\\PZX54\(P\^\)7CC\)7}\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H\+H\*/ }
];

const EXTENSIONS_TO_SCAN = ['.php', '.phtml', '.php5', '.pl', '.py', '.sh', '.cgi', '.html', '.htm', '.js', '.vbs', '.bat'];

/**
 * Scans a file buffer for malware signatures.
 * @param {Buffer} buffer - File content
 * @param {string} filename - File name
 * @returns {string|null} - Name of detection if found, otherwise null
 */
const scanBuffer = (buffer, filename) => {
    // 1. Check Extension validity for scanning
    const ext = filename.slice(((filename.lastIndexOf(".") - 1) >>> 0) + 2).toLowerCase();

    // Skip binary files/images to verify performance, only scan scripts
    if (!EXTENSIONS_TO_SCAN.includes(`.${ext}`)) return null;

    // 2. Convert buffer to text (limitation: only scans text-based malware)
    // For large files, we might only scan headers/footers, but for security we scan full (up to a limit).
    // Limit scan to first 1MB to avoid DOS? For now full scan.
    const content = buffer.toString('utf8');

    // 3. Match patterns
    for (const sig of MALWARE_SIGNATURES) {
        if (sig.pattern.test(content)) {
            return sig.name;
        }
    }
    return null;
};

module.exports = { scanBuffer, MALWARE_SIGNATURES };
