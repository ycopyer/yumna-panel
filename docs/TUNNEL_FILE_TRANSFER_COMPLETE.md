# Tunnel File Transfer Implementation Summary

## âœ… Completed Features (Milestone 3)

### 1. **Remote Shell / Terminal via Tunnel (WebSSH)**
**Status:** âœ… COMPLETE

**Components Modified:**
- `agent/src/services/TunnelClientService.js` - Shell session management
- `whm/src/services/TunnelManagerService.js` - Shell output buffering
- `whm/src/routes/terminal.js` - Terminal API endpoints
- `panel/src/components/admin/TunnelTerminal.tsx` - Interactive terminal UI
- `panel/src/components/admin/ServerManager.tsx` - Shell button integration

**Features:**
- Persistent shell sessions over WebSocket
- Real-time bidirectional I/O (stdin/stdout/stderr)
- Base64 encoding for binary-safe transmission
- Session management (start, input, kill)
- Support for both PowerShell (Windows) and Bash (Linux)

**Usage:**
1. Navigate to **Nodes** in admin panel
2. Click **SHELL** button on any Tunnel server
3. Interactive terminal opens with real-time command execution

---

### 2. **File Transfer via Tunnel (Chunked Binary Transfer)**
**Status:** âœ… COMPLETE

#### 2.1 Download (Agent â†’ WHM â†’ User)
**Implementation:**
- Streaming download with 64KB chunks
- Base64 encoding over WebSocket
- Direct pipe to HTTP response stream
- Support for files of any size (GB+)

**Flow:**
```
User Request â†’ WHM (/api/download) 
â†’ TunnelManager.registerDownloadListener() 
â†’ Agent.download_chunked 
â†’ FILE_CHUNK messages 
â†’ Stream to User
```

#### 2.2 Upload (User â†’ WHM â†’ Agent)
**Implementation:**
- Chunked upload with 2MB chunks (configurable)
- Multer for multipart/form-data handling
- Sequential chunk writing (index-based)
- Session management with UUID tracking

**Endpoints:**
- `POST /api/upload/init` - Initialize upload session
- `POST /api/upload/chunk` - Upload individual chunk
- `POST /api/upload/complete` - Finalize upload

**Flow:**
```
Frontend (useExplorerTransfer.ts) 
â†’ Init Session 
â†’ Upload Chunks (loop) 
â†’ WHM routes/files.js 
â†’ TunnelManager (if tunnel) 
â†’ Agent.upload_chunk 
â†’ Write to disk
```

#### 2.3 File Operations via Tunnel
**Supported Operations:**
- âœ… `ls` - List directory contents
- âœ… `read` - Read file content (text)
- âœ… `write` - Write/update file
- âœ… `mkdir` - Create directory
- âœ… `delete` - Delete file/folder (recursive)
- âœ… `rename` - Rename/move file
- âœ… `download_chunked` - Stream download
- âœ… `upload_chunk` - Chunked upload

**Components:**
- `whm/src/routes/files.js` - Unified file API (Direct + Tunnel)
- `agent/src/services/TunnelClientService.js` - File action handlers
- Frontend uses existing File Explorer UI (no changes needed)

---

### 3. **Tunnel Server Provisioning (Auto-Configuration)**
**Status:** âœ… COMPLETE

**Components:**
- `whm/src/routes/servers.js` - Provisioning endpoints
- `panel/src/components/admin/ServerManager.tsx` - Provisioning UI

**Features:**
- **UI Toggle:** Direct SSH vs Reverse Tunnel mode
- **Auto-Generation:** Agent ID and Secret automatically created
- **Database Storage:** Credentials saved securely
- **Installation Script:** One-liner command generation

**Endpoints:**
- `POST /api/servers/tunnel` - Create tunnel server entry
- `GET /api/servers/install-script?token=...` - Download install script

**Installation Script Capabilities:**
1. âœ… Install Node.js (if missing)
2. âœ… Clone/download Agent code
3. âœ… **Auto-create `.env` file** with:
   - `CONNECTION_MODE=tunnel`
   - `MASTER_URL=wss://your-panel.com/tunnel`
   - `AGENT_ID=<auto-generated>`
   - `AGENT_SECRET=<auto-generated>`
4. âœ… Install dependencies (`npm install`)
5. âœ… Start with PM2 (auto-restart on boot)

**Security:**
- Installation URL uses JWT token (1-hour expiry)
- Prevents unauthorized script downloads
- Credentials never exposed in plain URLs

**Usage:**
1. Admin Panel â†’ **Nodes** â†’ **Provision Node**
2. Select **Reverse Tunnel** mode
3. Click **Initialize Provisioning**
4. Copy the generated command:
   ```bash
   curl -sL "https://panel.com/api/servers/install-script?token=..." | bash
   ```
5. Run on remote VPS â†’ Agent auto-connects

---

## ğŸ“Š Architecture Overview

### Connection Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         WebSocket          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent (NAT)    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  WHM Master  â”‚
â”‚  (Outbound)     â”‚    wss://master/tunnel      â”‚  (Public IP) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                              â”‚
         â”‚ FILE_ACTION, SHELL_OUTPUT                    â”‚
         â”‚ FILE_CHUNK (Base64)                          â”‚
         â”‚                                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Transfer Protocol

#### Download
```
1. User â†’ GET /api/download?path=/file.zip
2. WHM â†’ resolveTarget() â†’ mode: 'tunnel'
3. WHM â†’ tunnelManager.registerDownloadListener(requestId, res)
4. WHM â†’ sendCommand(agentId, 'FILE_ACTION', { action: 'download_chunked' })
5. Agent â†’ fs.createReadStream() â†’ chunks
6. Agent â†’ ws.send({ type: 'FILE_CHUNK', data: base64(chunk) })
7. WHM â†’ handleFileChunk() â†’ res.write(chunk)
8. Agent â†’ ws.send({ type: 'FILE_CHUNK', isLast: true })
9. WHM â†’ res.end()
```

#### Upload
```
1. Frontend â†’ POST /api/upload/init
2. WHM â†’ Create session â†’ return uploadId
3. Frontend â†’ Loop: POST /api/upload/chunk (FormData)
4. WHM â†’ multer.single('chunk') â†’ buffer
5. WHM â†’ sendCommand(agentId, 'FILE_ACTION', { 
     action: 'upload_chunk', 
     data: base64(buffer),
     index: i 
   })
6. Agent â†’ Buffer.from(data, 'base64')
7. Agent â†’ fs.appendFile(filePath, buffer)
8. Frontend â†’ POST /api/upload/complete
9. WHM â†’ Delete session
```

---

## ğŸ”’ Security Considerations

### Current Implementation
- âœ… Agent authentication via `AGENT_SECRET`
- âœ… JWT tokens for install script access
- âœ… User authentication on all file endpoints
- âœ… Path resolution via `resolveTarget()`

### Production Recommendations
1. **Path Sanitization:** Implement chroot/jail for agent file operations
2. **Rate Limiting:** Add limits on upload/download bandwidth
3. **File Size Limits:** Configure max upload size per user role
4. **Audit Logging:** Log all file operations for compliance
5. **Encryption:** Consider encrypting FILE_CHUNK data (currently Base64)

---

## ğŸ“ˆ Performance Characteristics

### Download Performance
- **Chunk Size:** 64KB (configurable)
- **Encoding Overhead:** ~33% (Base64)
- **Memory Usage:** Streaming (constant, not file-size dependent)
- **Tested:** Files up to several GB

### Upload Performance
- **Chunk Size:** 2MB (frontend configurable)
- **Concurrent Chunks:** Sequential (prevents out-of-order writes)
- **Resume Support:** Via localStorage (frontend tracks progress)
- **Memory Usage:** O(chunk_size) on WHM, O(1) on Agent

---

## ğŸ§ª Testing Checklist

### Download Tests
- [x] Small text file (<1MB)
- [x] Large binary file (>100MB)
- [x] Connection interruption handling
- [x] Multiple concurrent downloads
- [x] Direct vs Tunnel mode comparison

### Upload Tests
- [x] Small file upload
- [x] Large file upload (>100MB)
- [ ] Resume after network failure (frontend supports, needs backend state persistence)
- [x] Concurrent uploads to different servers
- [x] Tunnel mode upload

### Shell Tests
- [x] Basic command execution
- [x] Interactive programs (vim, top)
- [x] Long-running commands
- [x] Binary output handling
- [x] Session cleanup on disconnect

---

## ğŸš€ Future Enhancements

### Priority 1 (High Impact)
1. **Upload Resume:** Persist upload sessions to Redis/DB
2. **Progress Tracking:** Real-time upload/download progress via WebSocket
3. **Compression:** Gzip FILE_CHUNK data before Base64 encoding
4. **Parallel Chunks:** Upload multiple chunks concurrently (requires ordering)

### Priority 2 (Nice to Have)
1. **File Encryption:** End-to-end encryption for sensitive files
2. **Bandwidth Throttling:** Per-user/per-server limits
3. **File Versioning:** Track file changes over tunnel
4. **Diff Transfer:** Only send changed blocks (rsync-style)

### Priority 3 (Advanced)
1. **P2P Tunneling:** Direct agent-to-agent file transfer
2. **Multi-hop Routing:** Route through intermediate agents
3. **Load Balancing:** Distribute file chunks across multiple tunnels

---

## ğŸ“ Configuration Reference

### Agent `.env` (Tunnel Mode)
```env
CONNECTION_MODE=tunnel
MASTER_URL=wss://panel.example.com/tunnel
AGENT_ID=agent-abc123-1234567890
AGENT_SECRET=32_char_random_hex_string
PORT=4001
```

### WHM `.env`
```env
AGENT_SECRET=shared_secret_for_direct_mode
JWT_SECRET=jwt_signing_secret
PUBLIC_URL=panel.example.com  # Used in install script
```

### Database Schema
```sql
-- servers table
ALTER TABLE servers ADD COLUMN connection_type VARCHAR(10) DEFAULT 'direct';
ALTER TABLE servers ADD COLUMN agent_id VARCHAR(100);
ALTER TABLE servers ADD COLUMN agentSecret VARCHAR(255);
```

---

## ğŸ“š API Documentation

### File Operations

#### List Directory
```http
GET /api/ls?path=/websites/example.com/public_html
Authorization: Bearer <token>
```

#### Download File
```http
GET /api/download?path=/websites/example.com/backup.zip&name=backup.zip
Authorization: Bearer <token>
```

#### Upload File (Chunked)
```http
# 1. Initialize
POST /api/upload/init
Content-Type: application/json
{ "name": "file.zip", "size": 1048576, "path": "/uploads" }

# 2. Upload chunks
POST /api/upload/chunk
Content-Type: multipart/form-data
FormData: { chunk: <blob>, uploadId: "uuid", index: 0, totalChunks: 10 }

# 3. Complete
POST /api/upload/complete
Content-Type: application/json
{ "uploadId": "uuid" }
```

### Terminal Operations

#### Start Shell
```http
POST /api/terminal/start
Content-Type: application/json
{ "agentId": "agent-abc123" }
```

#### Send Input
```http
POST /api/terminal/input
Content-Type: application/json
{ "agentId": "agent-abc123", "shellId": "uuid", "input": "ls -la\n" }
```

#### Get Output
```http
GET /api/terminal/output?agentId=agent-abc123&shellId=uuid
```

---

## âœ… Completion Status

| Feature | Status | Test Coverage | Documentation |
|---------|--------|---------------|---------------|
| WebSSH via Tunnel | âœ… Complete | âœ… Manual | âœ… Complete |
| File Download (Chunked) | âœ… Complete | âœ… Manual | âœ… Complete |
| File Upload (Chunked) | âœ… Complete | âœ… Manual | âœ… Complete |
| File Operations (CRUD) | âœ… Complete | âœ… Manual | âœ… Complete |
| Auto-Provisioning | âœ… Complete | âœ… Manual | âœ… Complete |
| Install Script Generator | âœ… Complete | âœ… Manual | âœ… Complete |

**Overall Progress: Milestone 3 - 100% COMPLETE** ğŸ‰

---

## ğŸ› Known Issues & Limitations

1. **Upload Resume:** Not yet implemented (frontend tracks, backend doesn't persist)
2. **Binary Encoding Overhead:** Base64 adds 33% size overhead
3. **Sequential Uploads:** Chunks must be uploaded in order
4. **No Compression:** Large text files could benefit from gzip
5. **Path Security:** Production needs stricter path validation

---

## ğŸ“ Support & Troubleshooting

### Common Issues

**Issue:** Agent won't connect to Master
- Check `MASTER_URL` format (must be `wss://` for HTTPS panels)
- Verify `AGENT_SECRET` matches on both sides
- Check firewall allows outbound WebSocket connections

**Issue:** File upload fails
- Check disk space on target server
- Verify user has write permissions to target path
- Check upload size limits in nginx/apache config

**Issue:** Shell session hangs
- Check if command requires interactive input
- Verify shell process hasn't crashed (check agent logs)
- Try killing and restarting the session

---

**Last Updated:** 2026-01-14  
**Version:** 3.2.0  
**Author:** YumnaPanel Development Team
